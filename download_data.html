<!DOCTYPE html>
<html>
<head>
  <title>KoFlux - Download Data</title>
  <style>
    :root {
      --main-blue: rgba(51, 85, 127, 1);
      --light-blue: #5bc0de;
      --page-background: #f8f8f8;
      --font-family: "Malgun Gothic", "맑은 고딕", sans-serif;
    }
    body { background-color: var(--page-background); color: #333333; font-family: var(--font-family); margin: 0; }
    .container { max-width: 1000px; margin: 0 auto; background-color: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); padding-top: 1px; min-height: 100vh; }
    .header-top { background-color: var(--main-blue); color: white; padding: 10px 20px; }
    .header-top h2 { margin: 0; font-size: 28px; display: inline-block; }
    .header-top span { font-size: 14px; margin-left: 10px; }

    .navbar { background-color: var(--main-blue); overflow: visible; min-height: 50px; padding: 0 20px; margin-bottom: 20px; }
    .navbar-item { float: left; position: relative; }
    .navbar-item a { display: block; color: white; text-align: center; padding: 15px 18px; text-decoration: none; font-weight: bold; font-size: 14px; }
    .navbar-item.active > a { background-color: var(--light-blue); color: black; }
    .navbar-item:hover > a { background-color: var(--light-blue); color: black; }
    .dropdown-content { display: none; position: absolute; background-color: white; min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1000; left: 0; top: 100%; }
    .dropdown-content a { color: #333; padding: 12px 16px; text-decoration: none; display: block; text-align: left; float: none; font-weight: normal; }
    .navbar-item:hover .dropdown-content { display: block; }

    .content-area { padding: 0 20px 20px 20px; display: flex; }
    .main-content { flex: 3; padding-right: 20px; }
    .sidebar { flex: 1; padding-left: 20px; border-left: 1px solid #eee; font-size: 14px; }
    .sidebar h4 { color: var(--main-blue); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 0; }
    .sidebar .site-map-link img { width: 100%; margin: 5px 0; }

    .form-section { margin-bottom: 25px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; }
    .site-selector { display: flex; justify-content: space-between; align-items: flex-start; }
    .list-container { flex: 1; }
    .site-selector select { width: 100%; height: 250px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; font-family: var(--font-family); }
    .site-selector-buttons { display: flex; flex-direction: column; justify-content: center; padding: 0 15px; margin-top: 25px; }
    .site-selector-buttons button { background-color: var(--main-blue); color: white; border: none; padding: 8px 12px; margin: 5px 0; border-radius: 4px; cursor: pointer; font-size: 16px; }
    
    #download-button { background-color: #5cb85c; color: white; font-weight: bold; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; }
    #download-button:disabled { background-color: #ccc; cursor: not-allowed; }
    #char-count-warning { color: red; font-size: 13px; display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-top">
      <h2>KoFlux</h2>
      <span>The Data Portal serving the KoFlux Community</span>
    </div>
    
    <div class="navbar">
      <div class="navbar-item"><a href="index.html">Home</a></div>
      <div class="navbar-item">
        <a href="about_koflux.html">About</a>
        <div class="dropdown-content">
          <a href="about_koflux.html">About KoFlux</a>
          <a href="regional_networks.html">Regional Networks</a>
        </div>
      </div>
      <div class="navbar-item"><a href="community.html">Community</a></div>
      <div class="navbar-item">
        <a href="#">Sites</a>
        <div class="dropdown-content">
          <a href="sites_info.html">Site Summary</a>
          <a href="site_list.html">Site List</a>
        </div>
      </div>
      <div class="navbar-item"><a href="#">Education</a></div>
      <div class="navbar-item active">
        <a href="#">Data</a>
        <div class="dropdown-content">
          <a href="about_data.html">About Data</a>
          <a href="download_data.html">Download Data</a>
        </div>
      </div>
      <div class="navbar-item" style="float: right;"><a href="signin.html" id="nav-auth-text">Sign In</a></div>
    </div>

    <div class="content-area">
      <div class="main-content">
        <h1>Download Data</h1>
        <div class="form-section">
          <h3>1. Select Sites</h3>
          <div class="site-selector">
            <div class="list-container">
              <select id="all-sites" multiple>
                <option value="AMD">AMD: Anmyeondo Coniferous forest</option>
                <option value="CFK">CFK: Cheongmicheon Farmland</option>
                <option value="CRK">CRK: Cheorwon Rice paddy</option>
                <option value="GBK">GBK: Gimje Soybean Field</option>
                <option value="GCK">GCK: Gwangreung Coniferous forest</option>
                <option value="GDK">GDK: Gwangreung Deciduous forest</option>
                <option value="GRK_1">GRK: Gimje Rice Paddy</option>
                <option value="GRK_2">GRK: Gimje Rice-barley double cropping Paddy Field</option>
                <option value="HC">HC: Hongcheon Mixed forest</option>
                <option value="HFK">HFK: Haenam Farmland</option>
                <option value="HPK">HPK: Haenam Paddy-field</option>
                <option value="JJ">JJ: Jeju Mixed forest</option>
                <option value="NRK1_2">NRK1, 2: Naju Rice Paddy</option>
                <option value="PYC">PYC: Pyeongchang Deciduous forest</option>
                <option value="SC">SC: Samcheok Coniferous forest</option>
                <option value="SMK">SMK: Seolmacheon Mixed forest</option>
                <option value="SRK">SRK: Seocheon Reservoir</option>
                <option value="TBK">TBK: Taehwa Broadleaf forest</option>
                <option value="TCK">TCK: Taehwa Coniferous forest</option>
                <option value="UOK">UOK: Uiseong Apple Orchard</option>
                <option value="WD">WD: Wando Evergreen broadleaf forest</option>
              </select>
            </div>
            <div class="site-selector-buttons">
              <button id="add-site">&gt;</button>
              <button id="remove-site">&lt;</button>
            </div>
            <div class="list-container">
              <select id="selected-sites" multiple></select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>2. Define Intended Use</h3>
          <select id="intended-use">
            <option value="">Select...</option>
            <option value="research">Research</option>
            <option value="education">Education</option>
            <option value="other">Other</option>
          </select>
          <textarea id="intended-use-details" placeholder="Min 20 chars" style="width:100%; height:100px; margin-top:10px;"></textarea>
          <div id="char-count-warning">Please enter at least 20 characters.</div>
        </div>

        <div class="form-section">
          <h3>3. Agree to Policy</h3>
          <input type="checkbox" id="agree-policy"> Agree to Policy
          <button id="download-button" disabled style="display:block; margin-top:15px;">Download All Files</button>
          <div id="form-status" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="sidebar">
        <h4>KoFlux Sites</h4>
        <a href="site_list.html" class="site-map-link">
          <img src="picture4.png" alt="KoFlux Sites Map">
        </a>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase 구성 설정
    const firebaseConfig = { 
      apiKey: "AIzaSyDmsWgnQqeojm3cNobdTUQSt0m3IE3lKJU",
      authDomain: "project0-a0afb.firebaseapp.com", 
      projectId: "project0-a0afb",
      storageBucket: "project0-a0afb.firebasestorage.app",
      messagingSenderId: "498452008968",
      appId: "1:498452008968:web:c7c162b4e8354cd37441bd"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "project0-a0afb";

    onAuthStateChanged(auth, (user) => {
      document.getElementById('nav-auth-text').textContent = user ? "Profile" : "Sign In";
    });

    const downloadBtn = document.getElementById('download-button');
    const details = document.getElementById('intended-use-details');
    const agree = document.getElementById('agree-policy');
    const use = document.getElementById('intended-use');

    function validate() {
      const isDetailsValid = details.value.trim().length >= 20;
      downloadBtn.disabled = !(agree.checked && use.value && isDetailsValid);
      document.getElementById('char-count-warning').style.display = (details.value.trim().length > 0 && !isDetailsValid) ? 'block' : 'none';
    }
    
    details.oninput = validate;
    agree.onchange = validate;
    use.onchange = validate;

    document.getElementById('add-site').onclick = () => {
      Array.from(document.getElementById('all-sites').selectedOptions).forEach(opt => {
        document.getElementById('selected-sites').appendChild(opt);
      });
      validate();
    };
    
    document.getElementById('remove-site').onclick = () => {
      Array.from(document.getElementById('selected-sites').selectedOptions).forEach(opt => {
        document.getElementById('all-sites').appendChild(opt);
      });
      validate();
    };

    downloadBtn.onclick = async () => {
      if (!auth.currentUser) {
        try {
          await signInAnonymously(auth);
        } catch (authErr) {
          console.error("Anonymous auth failed:", authErr);
          document.getElementById('form-status').innerHTML = "<span style='color:red'>Authentication Error. Please try again later.</span>";
          return;
        }
      }

      const sites = Array.from(document.getElementById('selected-sites').options).map(o => o.value);
      if (sites.length === 0) {
        document.getElementById('form-status').innerHTML = "<span style='color:red'>Please select at least one site.</span>";
        return;
      }

      try {
        await addDoc(collection(db, `artifacts/${appId}/public/data/download_requests`), {
          userId: auth.currentUser.uid,
          sites: sites,
          details: details.value,
          intendedUse: use.value,
          timestamp: new Date().toISOString()
        });

        document.getElementById('form-status').innerHTML = "<span style='color:green'>Success! Starting downloads...</span>";
        
        sites.forEach((code, i) => {
          setTimeout(() => {
            // GRK_1, GRK_2, NRK1_2 등 언더바(_) 뒤의 구분자 제거 로직
            const baseCode = code.split('_')[0];
            const fileName = `FLX_KR-${baseCode}_KoFlux.zip`;
            const a = document.createElement('a');
            a.href = `https://gwnu000.github.io/data/${fileName}`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }, i * 1000);
        });
      } catch (e) { 
        console.error("Firestore error:", e);
        document.getElementById('form-status').innerHTML = "<span style='color:red'>Error saving request. Please check permissions.</span>";
      }
    };
  </script>
</body>
</html>
