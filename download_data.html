<!DOCTYPE html>
<html>
<head>
  <title>KoFlux - Download Data</title>
  <style>
    :root {
      --main-blue: rgba(51, 85, 127, 1);
      --light-blue: #5bc0de;
      --page-background: #f8f8f8;
      --font-family: "Malgun Gothic", "맑은 고딕", sans-serif;
    }
    body { background-color: var(--page-background); color: #333333; font-family: var(--font-family); margin: 0; }
    .container { max-width: 1000px; margin: 0 auto; background-color: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); padding-top: 1px; min-height: 100vh; }
    .header-top { background-color: var(--main-blue); color: white; padding: 10px 20px; }
    .header-top h2 { margin: 0; font-size: 28px; display: inline-block; }
    .header-top span { font-size: 14px; margin-left: 10px; }

    .navbar { background-color: var(--main-blue); overflow: visible; min-height: 50px; padding: 0 20px; margin-bottom: 20px; }
    .navbar-item { float: left; position: relative; }
    .navbar-item a { display: block; color: white; text-align: center; padding: 15px 18px; text-decoration: none; font-weight: bold; font-size: 14px; }
    .navbar-item.active > a { background-color: var(--light-blue); color: black; }
    .navbar-item:hover > a { background-color: var(--light-blue); color: black; }
    .dropdown-content { display: none; position: absolute; background-color: white; min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1000; left: 0; top: 100%; }
    .dropdown-content a { color: #333; padding: 12px 16px; text-decoration: none; display: block; text-align: left; float: none; font-weight: normal; }
    .navbar-item:hover .dropdown-content { display: block; }

    .content-area { padding: 0 20px 20px 20px; display: flex; }
    .main-content { flex: 3; padding-right: 20px; }
    .sidebar { flex: 1; padding-left: 20px; border-left: 1px solid #eee; font-size: 14px; }
    .sidebar h4 { color: var(--main-blue); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 0; }
    .sidebar .site-map-link img { width: 100%; margin: 5px 0; }

    .form-section { margin-bottom: 25px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; }
    .site-selector { display: flex; justify-content: space-between; align-items: flex-start; }
    .list-container { flex: 1; }
    .site-selector select { width: 100%; height: 250px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; font-family: var(--font-family); }
    .site-selector-buttons { display: flex; flex-direction: column; justify-content: center; padding: 0 15px; margin-top: 25px; }
    .site-selector-buttons button { background-color: var(--main-blue); color: white; border: none; padding: 8px 12px; margin: 5px 0; border-radius: 4px; cursor: pointer; font-size: 16px; }
    
    #download-button { background-color: #5cb85c; color: white; font-weight: bold; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; }
    #download-button:disabled { background-color: #ccc; cursor: not-allowed; }
    #char-count-warning { color: red; font-size: 13px; display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-top">
      <h2>KoFlux</h2>
      <span>The Data Portal serving the KoFlux Community</span>
    </div>
    
    <div class="navbar">
      <div class="navbar-item"><a href="index.html">Home</a></div>
      <div class="navbar-item">
        <a href="about_koflux.html">About</a>
        <div class="dropdown-content">
          <a href="about_koflux.html">About KoFlux</a>
          <a href="regional_networks.html">Regional Networks</a>
        </div>
      </div>
      <div class="navbar-item"><a href="community.html">Community</a></div>
      <div class="navbar-item">
        <a href="#">Sites</a>
        <div class="dropdown-content">
          <a href="sites_info.html">Site Summary</a>
          <a href="site_list.html">Site List</a>
        </div>
      </div>
      <div class="navbar-item"><a href="#">Education</a></div>
      <div class="navbar-item active">
        <a href="#">Data</a>
        <div class="dropdown-content">
          <a href="about_data.html">About Data</a>
          <a href="download_data.html">Download Data</a>
        </div>
      </div>
      <div class="navbar-item" style="float: right;"><a href="signin.html" id="nav-auth-text">Sign In</a></div>
    </div>

    <div class="content-area">
      <div class="main-content">
        <h1>Download Data</h1>
        <!-- Form Structure... (As per previous design) -->
        <div class="form-section">
          <h3>1. Select Sites</h3>
          <div class="site-selector">
            <div class="list-container">
              <select id="all-sites" multiple>
                <option value="AMD">AMD: Anmyeondo Coniferous forest</option>
                <option value="CRK">CRK: Cheorwon Rice paddy</option>
                <option value="GRK_1">GRK: Gimje Rice Paddy</option>
                <option value="GRK_2">GRK: Gimje Rice-barley double cropping Paddy Field</option>
              </select>
            </div>
            <div class="site-selector-buttons">
              <button id="add-site">&gt;</button>
              <button id="remove-site">&lt;</button>
            </div>
            <div class="list-container">
              <select id="selected-sites" multiple></select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>2. Define Intended Use</h3>
          <select id="intended-use"><option value="">Select...</option><option value="research">Research</option></select>
          <textarea id="intended-use-details" placeholder="Min 20 chars" style="width:100%; height:100px; margin-top:10px;"></textarea>
          <div id="char-count-warning">Please enter at least 20 characters.</div>
        </div>

        <div class="form-section">
          <h3>3. Agree to Policy</h3>
          <input type="checkbox" id="agree-policy"> Agree to Policy
          <button id="download-button" disabled style="display:block; margin-top:15px;">Download All Files</button>
          <div id="form-status" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="sidebar">
        <h4>KoFlux Sites</h4>
        <a href="site_list.html" class="site-map-link">
          <img src="picture4.png" alt="KoFlux Sites Map">
        </a>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { authDomain: "project0-a0afb.firebaseapp.com", projectId: "project0-a0afb" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "project0-a0afb";

    onAuthStateChanged(auth, (user) => {
      document.getElementById('nav-auth-text').textContent = user ? "Profile" : "Sign In";
    });

    // Validation & Download Logic...
    const downloadBtn = document.getElementById('download-button');
    const details = document.getElementById('intended-use-details');
    const agree = document.getElementById('agree-policy');
    const use = document.getElementById('intended-use');

    function validate() {
      downloadBtn.disabled = !(agree.checked && use.value && details.value.trim().length >= 20);
      document.getElementById('char-count-warning').style.display = (details.value.trim().length > 0 && details.value.trim().length < 20) ? 'block' : 'none';
    }
    details.oninput = validate;
    agree.onchange = validate;
    use.onchange = validate;

    // Site Move Logic
    document.getElementById('add-site').onclick = () => {
      Array.from(document.getElementById('all-sites').selectedOptions).forEach(opt => document.getElementById('selected-sites').appendChild(opt));
    };
    document.getElementById('remove-site').onclick = () => {
      Array.from(document.getElementById('selected-sites').selectedOptions).forEach(opt => document.getElementById('all-sites').appendChild(opt));
    };

    downloadBtn.onclick = async () => {
      if (!auth.currentUser) await signInAnonymously(auth);
      const sites = Array.from(document.getElementById('selected-sites').options).map(o => o.value);
      try {
        await addDoc(collection(db, `artifacts/${appId}/public/data/download_requests`), {
          userId: auth.currentUser.uid,
          sites: sites,
          details: details.value,
          timestamp: new Date().toISOString()
        });
        document.getElementById('form-status').innerHTML = "<span style='color:green'>Success! Starting downloads...</span>";
        sites.forEach((code, i) => {
          setTimeout(() => {
            const a = document.createElement('a');
            a.href = `https://gwnu000.github.io/data/FLX_KR-${code.split('_')[0]}_KoFlux.zip`;
            a.download = `FLX_KR-${code.split('_')[0]}_KoFlux.zip`;
            a.click();
          }, i * 1000);
        });
      } catch (e) { console.error(e); }
    };
  </script>
</body>
</html>
